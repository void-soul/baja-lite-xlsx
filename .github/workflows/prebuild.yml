name: Prebuild Native Module (Windows Only)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows x64 - Node 20
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install xlnt:x64-windows
        shell: powershell
      
      - name: Set environment variables
        run: |
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
        shell: powershell
      
      - name: Install dependencies
        run: npm install --ignore-scripts
      
      - name: Build native module
        run: npm run build
      
      - name: Create prebuild package
        run: npx prebuild --runtime napi --target 8 --strip
      
      - name: List generated files
        run: |
          Write-Host "Generated prebuild files:"
          Get-ChildItem prebuilds -Recurse | Format-Table Name, Length
        shell: powershell
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: prebuilds-windows-x64-node20
          path: prebuilds/

  release:
    name: Create Release
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Download prebuild artifacts
        uses: actions/download-artifact@v3
        with:
          name: prebuilds-windows-x64-node20
          path: prebuilds
      
      - name: List files to be released
        run: |
          echo "Files to be released:"
          ls -lah prebuilds/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: prebuilds/*
          draft: false
          prerelease: false
          body: |
            ## 预编译包说明
            
            此版本包含 Windows x64 平台的预编译包，适用于 Node.js v20+。
            
            ### 支持的平台
            - ✅ Windows x64 (Node.js >= 20)
            
            ### 不支持的平台
            其他平台（Linux、macOS）或其他 Node.js 版本的用户安装时会自动回退到源码编译。
            
            ### 安装
            ```bash
            npm install baja-lite-xlsx
            ```
            
            Windows + Node 20 用户将自动下载预编译包，无需编译环境。
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


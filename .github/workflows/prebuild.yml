name: Prebuild Native Module

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows x64 - Node 20
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install vcpkg and dependencies
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          Write-Host "Installing xlnt and libzip..."
          .\vcpkg install xlnt:x64-windows libzip:x64-windows
          Write-Host "Installation complete!"
        shell: powershell
      
      - name: Set environment variables
        run: |
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          [System.Environment]::SetEnvironmentVariable('VCPKG_ROOT', 'C:\vcpkg', [System.EnvironmentVariableTarget]::Process)
        shell: powershell
      
      - name: Verify vcpkg installation
        run: |
          Write-Host "VCPKG_ROOT: C:\vcpkg"
          Write-Host ""
          Write-Host "Checking xlnt installation..."
          if (Test-Path "C:\vcpkg\installed\x64-windows\include\xlnt\xlnt.hpp") {
            Write-Host "[OK] xlnt.hpp found"
          } else {
            Write-Host "[ERROR] xlnt.hpp NOT found"
            exit 1
          }
          if (Test-Path "C:\vcpkg\installed\x64-windows\lib\xlnt.lib") {
            Write-Host "[OK] xlnt.lib found"
          } else {
            Write-Host "[ERROR] xlnt.lib NOT found"
            exit 1
          }
          Write-Host ""
          Write-Host "Checking libzip installation..."
          if (Test-Path "C:\vcpkg\installed\x64-windows\include\zip.h") {
            Write-Host "[OK] zip.h found"
          } else {
            Write-Host "[ERROR] zip.h NOT found"
            exit 1
          }
          if (Test-Path "C:\vcpkg\installed\x64-windows\lib\zip.lib") {
            Write-Host "[OK] zip.lib found"
          } else {
            Write-Host "[ERROR] zip.lib NOT found"
            exit 1
          }
          Write-Host ""
          Write-Host "[SUCCESS] All dependencies verified!"
        shell: powershell
      
      - name: Configure binding.gyp for CI
        run: |
          node -e "const fs = require('fs'); let content = fs.readFileSync('binding.gyp', 'utf8'); content = content.replace(/<!\(echo %VCPKG_ROOT%\)/g, 'C:/vcpkg'); fs.writeFileSync('binding.gyp', content); console.log('[OK] Updated binding.gyp with vcpkg path');"
          Get-Content binding.gyp | Select-String -Pattern "C:/vcpkg" | ForEach-Object { Write-Host "Verified: $_" }
        shell: powershell
      
      - name: Install npm dependencies
        run: npm install --ignore-scripts
        env:
          VCPKG_ROOT: C:\vcpkg

      - name: Build native module
        run: npm run build
        env:
          VCPKG_ROOT: C:\vcpkg
      
      - name: Create prebuild package
        run: npx prebuild --runtime napi --target 8 --strip
        env:
          VCPKG_ROOT: C:\vcpkg
      
      - name: List generated files
        run: |
          Write-Host "Generated prebuild files:"
          Get-ChildItem prebuilds -Recurse | Format-Table Name, Length
        shell: powershell
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-windows-x64-node20
          path: prebuilds/

  release:
    name: Create Release
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download prebuild artifacts
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-windows-x64-node20
          path: prebuilds
      
      - name: List files to be released
        run: |
          echo "Files to be released:"
          ls -lah prebuilds/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: prebuilds/*
          draft: false
          prerelease: false
          body: |
            ## ğŸ“¦ é¢„ç¼–è¯‘åŒ…è¯´æ˜
            
            æ­¤ç‰ˆæœ¬åŒ…å« **Windows x64** å¹³å°çš„é¢„ç¼–è¯‘åŒ…ï¼Œé€‚ç”¨äº **Node.js 20+**ã€‚
            
            ### âœ… æ”¯æŒçš„å¹³å°ï¼ˆé¢„ç¼–è¯‘åŒ…ï¼‰
            
            | å¹³å° | æ¶æ„ | Node.js ç‰ˆæœ¬ | å®‰è£…æ–¹å¼ |
            |------|------|--------------|----------|
            | **Windows** | x64 | **20+** | ğŸš€ **è‡ªåŠ¨ä¸‹è½½é¢„ç¼–è¯‘åŒ…** |
            
            ### ğŸ”§ å…¶ä»–å¹³å°/ç‰ˆæœ¬ï¼ˆæºç ç¼–è¯‘ï¼‰
            
            | å¹³å° | Node.js ç‰ˆæœ¬ | å®‰è£…æ–¹å¼ |
            |------|--------------|----------|
            | Windows | 16, 18 | âš™ï¸ è‡ªåŠ¨æºç ç¼–è¯‘ |
            | Linux | 16, 18, 20+ | âš™ï¸ è‡ªåŠ¨æºç ç¼–è¯‘ |
            | macOS | 16, 18, 20+ | âš™ï¸ è‡ªåŠ¨æºç ç¼–è¯‘ |
            
            ---
            
            ## ğŸ“¥ å®‰è£…
            
            ### Windows + Node 20 ç”¨æˆ·ï¼ˆæ¨èï¼‰
            
            ```bash
            npm install baja-lite-xlsx
            ```
            
            âœ… **æ— éœ€ä»»ä½•ç¼–è¯‘ç¯å¢ƒ**ï¼Œè‡ªåŠ¨ä¸‹è½½é¢„ç¼–è¯‘åŒ…ï¼Œå³è£…å³ç”¨ï¼
            
            ### å…¶ä»–ç¯å¢ƒ
            
            ```bash
            npm install baja-lite-xlsx
            ```
            
            âš™ï¸ **éœ€è¦ç¼–è¯‘ç¯å¢ƒ**ï¼ˆå®‰è£…æ—¶è‡ªåŠ¨ç¼–è¯‘ï¼‰
            
            #### Windowsï¼ˆNode 16/18ï¼‰ç¼–è¯‘è¦æ±‚
            
            ```bash
            # éœ€è¦å®‰è£…ï¼š
            # 1. Visual Studio 2019+ æˆ– Build Tools for Visual Studio
            # 2. vcpkg
            # 3. xlnt (é€šè¿‡ vcpkg install xlnt:x64-windows)
            ```
            
            #### Linux ç¼–è¯‘è¦æ±‚
            
            **Ubuntu/Debian:**
            ```bash
            sudo apt-get install -y build-essential cmake git
            ```
            
            **CentOS/RHEL:**
            ```bash
            sudo yum groupinstall "Development Tools"
            sudo yum install cmake git
            ```
            
            #### macOS ç¼–è¯‘è¦æ±‚
            
            ```bash
            xcode-select --install
            ```
            
            ---
            
            ## ğŸ¯ é¢„ç¼–è¯‘åŒ…è¯¦æƒ…
            
            **åŒ…å«çš„æ–‡ä»¶ï¼š**
            - `napi-v8-win32-x64.tar.gz` - Windows x64, Node.js 20+
            
            **è‡ªåŠ¨åŒ¹é…ï¼š**
            - âœ… Windows 10/11 x64
            - âœ… Windows Server 2019+ x64
            - âœ… Node.js 20.x
            
            **ä¸åŒ¹é…æ—¶è‡ªåŠ¨å›é€€åˆ°æºç ç¼–è¯‘**
            
            ---
            
            ## ğŸ“š æ–‡æ¡£ä¸ç¤ºä¾‹
            
            - [ğŸ“– å®Œæ•´æ–‡æ¡£](https://github.com/void-soul/baja-lite-xlsx#readme)
            - [ğŸš€ å¿«é€Ÿå¼€å§‹](https://github.com/void-soul/baja-lite-xlsx/blob/master/QUICKSTART.md)
            - [ğŸ’» ç¤ºä¾‹ä»£ç ](https://github.com/void-soul/baja-lite-xlsx/tree/master/examples)
            - [ğŸ”§ API æ–‡æ¡£](https://github.com/void-soul/baja-lite-xlsx/blob/master/API_USAGE_CN.md)
            
            ## ğŸ› é—®é¢˜åé¦ˆ
            
            é‡åˆ°é—®é¢˜ï¼Ÿè¯·æäº¤ [Issue](https://github.com/void-soul/baja-lite-xlsx/issues)
            
            ---
            
            ## ğŸ“Š æŠ€æœ¯ç»†èŠ‚
            
            **é¢„ç¼–è¯‘åŒ…ä¿¡æ¯ï¼š**
            - å¤§å°: ~500KB - 1MBï¼ˆå‹ç¼©åï¼‰
            - Runtime: N-API v8
            - æ¶æ„: x64
            - ä¼˜åŒ–: Release + Strip
            - ä¾èµ–: xlnt, libzip, zlib
            
            **å…¼å®¹æ€§ï¼š**
            - âœ… N-API v8 (Node.js >= 20)
            - âœ… Windows SDK 10.0+
            - âœ… MSVC 2019+
            
            **åŠŸèƒ½ç‰¹æ€§ï¼š**
            - âœ… è¯»å– Excel æ•°æ®
            - âœ… æå–å›¾ç‰‡
            - âœ… æ”¯æŒå¤š Sheet
            - âœ… æ”¯æŒ Buffer/base64 è¾“å…¥
            - âœ… TypeScript ç±»å‹æ”¯æŒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

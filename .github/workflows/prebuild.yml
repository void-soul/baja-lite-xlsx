name: Prebuild Native Module

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows x64 - Node 20
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install vcpkg and dependencies
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          Write-Host "Installing xlnt and libzip..."
          .\vcpkg install xlnt:x64-windows libzip:x64-windows
          Write-Host "Installation complete!"
        shell: powershell
      
      - name: Set environment variables
        run: |
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          [System.Environment]::SetEnvironmentVariable('VCPKG_ROOT', 'C:\vcpkg', [System.EnvironmentVariableTarget]::Process)
        shell: powershell
      
      - name: Verify vcpkg installation
        run: |
          Write-Host "VCPKG_ROOT: C:\vcpkg"
          Write-Host ""
          Write-Host "Checking xlnt installation..."
          if (Test-Path "C:\vcpkg\installed\x64-windows\include\xlnt\xlnt.hpp") {
            Write-Host "[OK] xlnt.hpp found"
          } else {
            Write-Host "[ERROR] xlnt.hpp NOT found"
            exit 1
          }
          if (Test-Path "C:\vcpkg\installed\x64-windows\lib\xlnt.lib") {
            Write-Host "[OK] xlnt.lib found"
          } else {
            Write-Host "[ERROR] xlnt.lib NOT found"
            exit 1
          }
          Write-Host ""
          Write-Host "Checking libzip installation..."
          if (Test-Path "C:\vcpkg\installed\x64-windows\include\zip.h") {
            Write-Host "[OK] zip.h found"
          } else {
            Write-Host "[ERROR] zip.h NOT found"
            exit 1
          }
          if (Test-Path "C:\vcpkg\installed\x64-windows\lib\zip.lib") {
            Write-Host "[OK] zip.lib found"
          } else {
            Write-Host "[ERROR] zip.lib NOT found"
            exit 1
          }
          Write-Host ""
          Write-Host "[SUCCESS] All dependencies verified!"
        shell: powershell
      
      - name: Configure binding.gyp for CI
        run: |
          node -e "const fs = require('fs'); let content = fs.readFileSync('binding.gyp', 'utf8'); content = content.replace(/<!\(echo %VCPKG_ROOT%\)/g, 'C:/vcpkg'); fs.writeFileSync('binding.gyp', content); console.log('[OK] Updated binding.gyp with vcpkg path');"
          Get-Content binding.gyp | Select-String -Pattern "C:/vcpkg" | ForEach-Object { Write-Host "Verified: $_" }
        shell: powershell
      
      - name: Install npm dependencies
        run: npm install --ignore-scripts
        env:
          VCPKG_ROOT: C:\vcpkg

      - name: Build native module
        run: npm run build
        env:
          VCPKG_ROOT: C:\vcpkg
      
      - name: Create prebuild package
        run: npx prebuild --runtime napi --target 8 --strip
        env:
          VCPKG_ROOT: C:\vcpkg
      
      - name: List generated files
        run: |
          Write-Host "Generated prebuild files:"
          Get-ChildItem prebuilds -Recurse | Format-Table Name, Length
        shell: powershell
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-windows-x64-node20
          path: prebuilds/

  release:
    name: Create Release
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download prebuild artifacts
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-windows-x64-node20
          path: prebuilds
      
      - name: List files to be released
        run: |
          echo "Files to be released:"
          ls -lah prebuilds/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: prebuilds/*
          draft: false
          prerelease: false
          body: |
            ## 📦 预编译包说明
            
            此版本包含 **Windows x64** 平台的预编译包，适用于 **Node.js 20+**。
            
            ### ✅ 支持的平台（预编译包）
            
            | 平台 | 架构 | Node.js 版本 | 安装方式 |
            |------|------|--------------|----------|
            | **Windows** | x64 | **20+** | 🚀 **自动下载预编译包** |
            
            ### 🔧 其他平台/版本（源码编译）
            
            | 平台 | Node.js 版本 | 安装方式 |
            |------|--------------|----------|
            | Windows | 16, 18 | ⚙️ 自动源码编译 |
            | Linux | 16, 18, 20+ | ⚙️ 自动源码编译 |
            | macOS | 16, 18, 20+ | ⚙️ 自动源码编译 |
            
            ---
            
            ## 📥 安装
            
            ### Windows + Node 20 用户（推荐）
            
            ```bash
            npm install baja-lite-xlsx
            ```
            
            ✅ **无需任何编译环境**，自动下载预编译包，即装即用！
            
            ### 其他环境
            
            ```bash
            npm install baja-lite-xlsx
            ```
            
            ⚙️ **需要编译环境**（安装时自动编译）
            
            #### Windows（Node 16/18）编译要求
            
            ```bash
            # 需要安装：
            # 1. Visual Studio 2019+ 或 Build Tools for Visual Studio
            # 2. vcpkg
            # 3. xlnt (通过 vcpkg install xlnt:x64-windows)
            ```
            
            #### Linux 编译要求
            
            **Ubuntu/Debian:**
            ```bash
            sudo apt-get install -y build-essential cmake git
            ```
            
            **CentOS/RHEL:**
            ```bash
            sudo yum groupinstall "Development Tools"
            sudo yum install cmake git
            ```
            
            #### macOS 编译要求
            
            ```bash
            xcode-select --install
            ```
            
            ---
            
            ## 🎯 预编译包详情
            
            **包含的文件：**
            - `napi-v8-win32-x64.tar.gz` - Windows x64, Node.js 20+
            
            **自动匹配：**
            - ✅ Windows 10/11 x64
            - ✅ Windows Server 2019+ x64
            - ✅ Node.js 20.x
            
            **不匹配时自动回退到源码编译**
            
            ---
            
            ## 📚 文档与示例
            
            - [📖 完整文档](https://github.com/void-soul/baja-lite-xlsx#readme)
            - [🚀 快速开始](https://github.com/void-soul/baja-lite-xlsx/blob/master/QUICKSTART.md)
            - [💻 示例代码](https://github.com/void-soul/baja-lite-xlsx/tree/master/examples)
            - [🔧 API 文档](https://github.com/void-soul/baja-lite-xlsx/blob/master/API_USAGE_CN.md)
            
            ## 🐛 问题反馈
            
            遇到问题？请提交 [Issue](https://github.com/void-soul/baja-lite-xlsx/issues)
            
            ---
            
            ## 📊 技术细节
            
            **预编译包信息：**
            - 大小: ~500KB - 1MB（压缩后）
            - Runtime: N-API v8
            - 架构: x64
            - 优化: Release + Strip
            - 依赖: xlnt, libzip, zlib
            
            **兼容性：**
            - ✅ N-API v8 (Node.js >= 20)
            - ✅ Windows SDK 10.0+
            - ✅ MSVC 2019+
            
            **功能特性：**
            - ✅ 读取 Excel 数据
            - ✅ 提取图片
            - ✅ 支持多 Sheet
            - ✅ 支持 Buffer/base64 输入
            - ✅ TypeScript 类型支持
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Prebuild Native Module (Multi-Platform)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.os }} - Node ${{ matrix.node }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [16, 18, 20]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      
      # Windows: Install dependencies via vcpkg
      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install xlnt:x64-windows
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
        shell: powershell
      
      # Linux: Install dependencies via apt
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3 libxlnt-dev || true
          # If libxlnt-dev not available, build from source
          if ! dpkg -l | grep -q libxlnt-dev; then
            git clone https://github.com/tfussell/xlnt.git /tmp/xlnt
            cd /tmp/xlnt
            mkdir build && cd build
            cmake ..
            make -j$(nproc)
            sudo make install
            sudo ldconfig
          fi
      
      # macOS: Install dependencies via Homebrew
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install xlnt || brew link xlnt
      
      - name: Install npm dependencies
        run: npm install --ignore-scripts
      
      - name: Build native module
        run: npm run build
      
      - name: Create prebuild package
        run: npx prebuild --runtime napi --target 8 --strip
      
      - name: List generated files (Windows)
        if: runner.os == 'Windows'
        run: |
          Write-Host "Generated prebuild files:"
          Get-ChildItem prebuilds -Recurse | Format-Table Name, Length
        shell: powershell
      
      - name: List generated files (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "Generated prebuild files:"
          find prebuilds -type f -exec ls -lh {} \;
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-${{ matrix.os }}-node${{ matrix.node }}
          path: prebuilds/

  release:
    name: Create Release
    needs: [build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Download all artifacts from all build jobs
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-prebuilds
      
      # Merge all prebuilds into one directory
      - name: Merge prebuilds
        run: |
          mkdir -p prebuilds
          find all-prebuilds -type f -name "*.tar.gz" -exec cp {} prebuilds/ \;
          echo "Merged prebuild files:"
          ls -lah prebuilds/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: prebuilds/*
          draft: false
          prerelease: false
          body: |
            ## ğŸ“¦ é¢„ç¼–è¯‘åŒ…è¯´æ˜
            
            æ­¤ç‰ˆæœ¬åŒ…å«å¤šå¹³å°é¢„ç¼–è¯‘åŒ…ï¼Œæ”¯æŒä»¥ä¸‹ç¯å¢ƒï¼š
            
            ### âœ… æ”¯æŒçš„å¹³å°
            
            | å¹³å° | æ¶æ„ | Node.js ç‰ˆæœ¬ | çŠ¶æ€ |
            |------|------|--------------|------|
            | **Windows** | x64 | 16, 18, 20 | âœ… |
            | **Linux** | x64 | 16, 18, 20 | âœ… |
            | **macOS** | x64/arm64 | 16, 18, 20 | âœ… |
            
            ### ğŸ“¥ å®‰è£…
            
            ```bash
            npm install baja-lite-xlsx
            ```
            
            **è‡ªåŠ¨ä¸‹è½½é¢„ç¼–è¯‘åŒ…ï¼š**
            - âœ… Windows x64 (Node 16/18/20)
            - âœ… Linux x64 (Node 16/18/20)
            - âœ… macOS (Node 16/18/20)
            
            ### ğŸ”§ æºç ç¼–è¯‘ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
            
            å¦‚æœæ‚¨çš„å¹³å°ä¸åœ¨ä¸Šè¿°åˆ—è¡¨ä¸­ï¼Œå®‰è£…æ—¶ä¼šè‡ªåŠ¨å›é€€åˆ°æºç ç¼–è¯‘ã€‚
            
            **Windows ç¼–è¯‘è¦æ±‚ï¼š**
            - Visual Studio 2019+ æˆ– Build Tools
            - vcpkg + xlnt
            
            **Linux ç¼–è¯‘è¦æ±‚ï¼š**
            - build-essential
            - libxlnt-dev æˆ–ä»æºç æ„å»º
            
            **macOS ç¼–è¯‘è¦æ±‚ï¼š**
            - Xcode Command Line Tools
            - Homebrew + xlnt
            
            ### ğŸ“š æ–‡æ¡£
            
            æŸ¥çœ‹ [README.md](https://github.com/void-soul/baja-lite-xlsx#readme) è·å–å®Œæ•´æ–‡æ¡£å’Œç¤ºä¾‹ã€‚
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æäº¤ [Issue](https://github.com/void-soul/baja-lite-xlsx/issues)ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

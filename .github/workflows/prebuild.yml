name: Prebuild Native Module

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows x64 - Node ${{ matrix.node }}
    runs-on: windows-latest
    
    strategy:
      fail-fast: false
      matrix:
        node: [16, 18, 20]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      
      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install xlnt:x64-windows
        shell: powershell
      
      - name: Set environment variables
        run: |
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
        shell: powershell
      
      - name: Install npm dependencies
        run: npm install --ignore-scripts
      
      - name: Build native module
        run: npm run build
      
      - name: Create prebuild package
        run: npx prebuild --runtime napi --target 8 --strip
      
      - name: List generated files
        run: |
          Write-Host "Generated prebuild files:"
          Get-ChildItem prebuilds -Recurse | Format-Table Name, Length
        shell: powershell
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-windows-node${{ matrix.node }}
          path: prebuilds/

  release:
    name: Create Release
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Download all Windows artifacts
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-prebuilds
      
      # Merge all prebuilds into one directory
      - name: Merge prebuilds
        run: |
          mkdir -p prebuilds
          find all-prebuilds -type f -name "*.tar.gz" -exec cp {} prebuilds/ \;
          echo "Merged prebuild files:"
          ls -lah prebuilds/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: prebuilds/*
          draft: false
          prerelease: false
          body: |
            ## ðŸ“¦ é¢„ç¼–è¯‘åŒ…è¯´æ˜Ž
            
            æ­¤ç‰ˆæœ¬åŒ…å« **Windows x64** å¹³å°çš„é¢„ç¼–è¯‘åŒ…ï¼Œæ”¯æŒå¤šä¸ª Node.js ç‰ˆæœ¬ã€‚
            
            ### âœ… æ”¯æŒçš„å¹³å°ï¼ˆé¢„ç¼–è¯‘åŒ…ï¼‰
            
            | å¹³å° | æž¶æž„ | Node.js ç‰ˆæœ¬ | å®‰è£…æ–¹å¼ |
            |------|------|--------------|----------|
            | **Windows** | x64 | 16, 18, 20 | ðŸš€ **è‡ªåŠ¨ä¸‹è½½é¢„ç¼–è¯‘åŒ…** |
            
            ### ðŸ”§ å…¶ä»–å¹³å°ï¼ˆæºç ç¼–è¯‘ï¼‰
            
            | å¹³å° | Node.js ç‰ˆæœ¬ | å®‰è£…æ–¹å¼ |
            |------|--------------|----------|
            | **Linux** | 16, 18, 20 | âš™ï¸ è‡ªåŠ¨æºç ç¼–è¯‘ |
            | **macOS** | 16, 18, 20 | âš™ï¸ è‡ªåŠ¨æºç ç¼–è¯‘ |
            
            ---
            
            ## ðŸ“¥ å®‰è£…
            
            ### Windows ç”¨æˆ·ï¼ˆæŽ¨èï¼‰
            
            ```bash
            npm install baja-lite-xlsx
            ```
            
            âœ… **æ— éœ€ä»»ä½•ç¼–è¯‘çŽ¯å¢ƒ**ï¼Œè‡ªåŠ¨ä¸‹è½½é¢„ç¼–è¯‘åŒ…ï¼
            
            ### Linux/macOS ç”¨æˆ·
            
            ```bash
            npm install baja-lite-xlsx
            ```
            
            âš™ï¸ **éœ€è¦ç¼–è¯‘çŽ¯å¢ƒ**ï¼ˆå®‰è£…æ—¶è‡ªåŠ¨ç¼–è¯‘ï¼‰
            
            #### Linux ç¼–è¯‘è¦æ±‚
            
            **Ubuntu/Debian:**
            ```bash
            sudo apt-get install -y build-essential cmake git
            ```
            
            **CentOS/RHEL:**
            ```bash
            sudo yum groupinstall "Development Tools"
            sudo yum install cmake git
            ```
            
            #### macOS ç¼–è¯‘è¦æ±‚
            
            ```bash
            xcode-select --install
            ```
            
            ---
            
            ## ðŸŽ¯ é¢„ç¼–è¯‘åŒ…è¯¦æƒ…
            
            **åŒ…å«çš„æ–‡ä»¶ï¼š**
            - `napi-v8-win32-x64.tar.gz` - Windows x64 (Node 16/18/20 é€šç”¨)
            
            **è‡ªåŠ¨åŒ¹é…ï¼š**
            - âœ… Windows 10/11 x64
            - âœ… Windows Server 2016+ x64
            - âœ… Node.js 16.x, 18.x, 20.x
            
            **ä¸åŒ¹é…æ—¶ï¼š**
            - âš™ï¸ è‡ªåŠ¨å›žé€€åˆ°æºç ç¼–è¯‘
            - éœ€è¦ Visual Studio 2019+ æˆ– Build Tools
            - éœ€è¦ vcpkg + xlnt
            
            ---
            
            ## ðŸ“š æ–‡æ¡£
            
            - [å®Œæ•´æ–‡æ¡£](https://github.com/void-soul/baja-lite-xlsx#readme)
            - [API æ–‡æ¡£](https://github.com/void-soul/baja-lite-xlsx/blob/master/README.md)
            - [ç¤ºä¾‹ä»£ç ](https://github.com/void-soul/baja-lite-xlsx/tree/master/examples)
            
            ## ðŸ› é—®é¢˜åé¦ˆ
            
            é‡åˆ°é—®é¢˜ï¼Ÿè¯·æäº¤ [Issue](https://github.com/void-soul/baja-lite-xlsx/issues)
            
            ---
            
            ## ðŸ“Š æŠ€æœ¯ç»†èŠ‚
            
            **é¢„ç¼–è¯‘åŒ…å¤§å°ï¼š** ~500KB - 1MBï¼ˆåŽ‹ç¼©åŽï¼‰
            
            **ç¼–è¯‘é€‰é¡¹ï¼š**
            - Runtime: N-API v8
            - æž¶æž„: x64
            - ä¼˜åŒ–: Release + Strip
            
            **å…¼å®¹æ€§ï¼š**
            - âœ… N-API v8 (Node.js >= 16)
            - âœ… Windows SDK 10.0+
            - âœ… MSVC 2019+
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

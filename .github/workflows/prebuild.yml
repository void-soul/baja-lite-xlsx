name: Prebuild Native Module

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows x64 - Node ${{ matrix.node }}
    runs-on: windows-latest
    
    strategy:
      fail-fast: false
      matrix:
        node: [16, 18, 20]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      
      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install xlnt:x64-windows
        shell: powershell
      
      - name: Set environment variables
        run: |
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
        shell: powershell
      
      - name: Install npm dependencies
        run: npm install --ignore-scripts
      
      - name: Build native module
        run: npm run build
      
      - name: Create prebuild package
        run: npx prebuild --runtime napi --target 8 --strip
      
      - name: List generated files
        run: |
          Write-Host "Generated prebuild files:"
          Get-ChildItem prebuilds -Recurse | Format-Table Name, Length
        shell: powershell
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-windows-node${{ matrix.node }}
          path: prebuilds/

  release:
    name: Create Release
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Download all Windows artifacts
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-prebuilds
      
      # Merge all prebuilds into one directory
      - name: Merge prebuilds
        run: |
          mkdir -p prebuilds
          find all-prebuilds -type f -name "*.tar.gz" -exec cp {} prebuilds/ \;
          echo "Merged prebuild files:"
          ls -lah prebuilds/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: prebuilds/*
          draft: false
          prerelease: false
          body: |
            ## 📦 预编译包说明
            
            此版本包含 **Windows x64** 平台的预编译包，支持多个 Node.js 版本。
            
            ### ✅ 支持的平台（预编译包）
            
            | 平台 | 架构 | Node.js 版本 | 安装方式 |
            |------|------|--------------|----------|
            | **Windows** | x64 | 16, 18, 20 | 🚀 **自动下载预编译包** |
            
            ### 🔧 其他平台（源码编译）
            
            | 平台 | Node.js 版本 | 安装方式 |
            |------|--------------|----------|
            | **Linux** | 16, 18, 20 | ⚙️ 自动源码编译 |
            | **macOS** | 16, 18, 20 | ⚙️ 自动源码编译 |
            
            ---
            
            ## 📥 安装
            
            ### Windows 用户（推荐）
            
            ```bash
            npm install baja-lite-xlsx
            ```
            
            ✅ **无需任何编译环境**，自动下载预编译包！
            
            ### Linux/macOS 用户
            
            ```bash
            npm install baja-lite-xlsx
            ```
            
            ⚙️ **需要编译环境**（安装时自动编译）
            
            #### Linux 编译要求
            
            **Ubuntu/Debian:**
            ```bash
            sudo apt-get install -y build-essential cmake git
            ```
            
            **CentOS/RHEL:**
            ```bash
            sudo yum groupinstall "Development Tools"
            sudo yum install cmake git
            ```
            
            #### macOS 编译要求
            
            ```bash
            xcode-select --install
            ```
            
            ---
            
            ## 🎯 预编译包详情
            
            **包含的文件：**
            - `napi-v8-win32-x64.tar.gz` - Windows x64 (Node 16/18/20 通用)
            
            **自动匹配：**
            - ✅ Windows 10/11 x64
            - ✅ Windows Server 2016+ x64
            - ✅ Node.js 16.x, 18.x, 20.x
            
            **不匹配时：**
            - ⚙️ 自动回退到源码编译
            - 需要 Visual Studio 2019+ 或 Build Tools
            - 需要 vcpkg + xlnt
            
            ---
            
            ## 📚 文档
            
            - [完整文档](https://github.com/void-soul/baja-lite-xlsx#readme)
            - [API 文档](https://github.com/void-soul/baja-lite-xlsx/blob/master/README.md)
            - [示例代码](https://github.com/void-soul/baja-lite-xlsx/tree/master/examples)
            
            ## 🐛 问题反馈
            
            遇到问题？请提交 [Issue](https://github.com/void-soul/baja-lite-xlsx/issues)
            
            ---
            
            ## 📊 技术细节
            
            **预编译包大小：** ~500KB - 1MB（压缩后）
            
            **编译选项：**
            - Runtime: N-API v8
            - 架构: x64
            - 优化: Release + Strip
            
            **兼容性：**
            - ✅ N-API v8 (Node.js >= 16)
            - ✅ Windows SDK 10.0+
            - ✅ MSVC 2019+
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

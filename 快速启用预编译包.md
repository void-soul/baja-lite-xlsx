# 快速启用预编译包

## 📋 一分钟了解

**当前模式：** 源码发布（用户需要编译）  
**预编译模式：** 提供预编译包（用户无需编译，安装快速）

**好处：**
- ✅ 用户安装快 10 倍（几秒 vs 几分钟）
- ✅ 用户无需安装 VS、Python、vcpkg 等
- ✅ 安装成功率接近 100%

**代价：**
- ⚠️ 需要 GitHub 仓库
- ⚠️ 需要配置 CI/CD 自动构建
- ⚠️ 包体积稍大（但用户下载的还是小）

---

## 🚀 快速开始（3步）

### 第1步：安装依赖

```bash
npm install --save prebuild-install
npm install --save-dev prebuild
```

### 第2步：替换 package.json

```bash
# 备份当前 package.json
cp package.json package.json.backup

# 使用预编译版本
cp package-prebuild.json package.json
```

或手动修改 `package.json`：

```json
{
  "scripts": {
    "install": "prebuild-install --runtime napi || node-gyp rebuild",
    "prebuild": "prebuild --runtime napi --target 8 --strip"
  },
  "binary": {
    "napi_versions": [3, 4, 5, 6, 7, 8]
  },
  "dependencies": {
    "prebuild-install": "^7.1.1"
  },
  "devDependencies": {
    "prebuild": "^12.1.0"
  }
}
```

### 第3步：配置 GitHub Actions

```bash
# 确保 .github/workflows/prebuild.yml 存在
# 已为你创建好了，查看该文件
```

---

## 📦 发布流程

### 自动发布（推荐）

```bash
# 1. 提交代码
git add .
git commit -m "feat: 添加预编译支持"
git push

# 2. 创建并推送 tag
npm version 1.0.1
git push origin v1.0.1

# 3. GitHub Actions 自动执行：
#    ✅ 在 Windows/Linux/macOS 上构建
#    ✅ 上传预编译包到 GitHub Releases
#    ✅ 大约需要 15-20 分钟

# 4. 等 Actions 完成后，发布到 npm
npm publish
```

### 手动构建（本地测试）

```bash
# Windows 上
npm run build
npm run prebuild

# 查看生成的预编译包
ls prebuilds/
# 输出: baja-lite-xlsx-v1.0.0-napi-v8-win32-x64.tar.gz
```

---

## ✅ 验证

### 检查 GitHub Release

1. 访问 `https://github.com/yourusername/baja-lite-xlsx/releases`
2. 应该看到类似的文件：
   ```
   baja-lite-xlsx-v1.0.1-napi-v8-win32-x64.tar.gz
   baja-lite-xlsx-v1.0.1-napi-v8-linux-x64.tar.gz
   baja-lite-xlsx-v1.0.1-napi-v8-darwin-x64.tar.gz
   baja-lite-xlsx-v1.0.1-napi-v8-darwin-arm64.tar.gz
   ```

### 测试用户安装

```bash
# 在干净的环境（无编译工具）
mkdir test-install
cd test-install
npm init -y
npm install baja-lite-xlsx

# 应该看到：
# > prebuild-install info begin Prebuild-install version X.X.X
# > prebuild-install info install installing standalone from url
# ✓ 安装成功（几秒钟）
```

---

## 🔍 对比

### 当前模式（源码发布）

```bash
$ npm install baja-lite-xlsx
⏰ 安装时间：3-10 分钟
📋 需要环境：
  - Visual Studio Build Tools
  - Python
  - vcpkg + xlnt
❌ 可能失败
```

### 预编译模式

```bash
$ npm install baja-lite-xlsx
⚡ 安装时间：3-10 秒
📋 需要环境：无
✅ 几乎不会失败
```

---

## 📊 统计示例

流行的预编译包下载统计：

| 包名 | 周下载量 | 预编译率 |
|------|---------|---------|
| sharp | 400万 | ~95% |
| sqlite3 | 200万 | ~90% |
| canvas | 150万 | ~92% |

使用预编译包后，你的包也能达到类似的成功率！

---

## 🛠️ 故障排除

### Q: Actions 构建失败？

**检查：**
1. VCPKG_ROOT 环境变量设置正确
2. xlnt 安装成功
3. 查看 Actions 日志详细错误

### Q: 用户下载预编译包失败？

**原因：**
- GitHub 访问受限
- 没有对应平台的预编译包

**解决：**
会自动回退到源码编译（`|| node-gyp rebuild`）

### Q: 如何只为特定平台构建？

修改 `.github/workflows/prebuild.yml`，删除不需要的 job。

---

## 💡 最佳实践

### 1. 保留源码编译作为后备

```json
"install": "prebuild-install --runtime napi || node-gyp rebuild"
```

这样即使下载失败，用户仍可编译。

### 2. 使用 N-API

已配置：
```json
"binary": {
  "napi_versions": [3, 4, 5, 6, 7, 8]
}
```

好处：一个构建支持多个 Node.js 版本

### 3. 启用 strip

```json
"prebuild": "prebuild --runtime napi --target 8 --strip"
```

移除调试符号，减小 50% 体积。

### 4. 多 Node.js 版本测试

在 Actions 中测试 Node 16、18、20。

---

## 📝 Checklist

启用预编译包前确认：

- [ ] 有 GitHub 仓库
- [ ] 已安装 `prebuild` 和 `prebuild-install`
- [ ] 已配置 `.github/workflows/prebuild.yml`
- [ ] 已更新 `package.json`
- [ ] 已测试本地构建
- [ ] 已推送代码到 GitHub
- [ ] 准备好创建 Release

---

## 🎯 下一步

1. **现在就试试：** 按照上面 3 步配置
2. **推送 tag 测试：** `git tag v1.0.1-beta && git push origin v1.0.1-beta`
3. **观察 Actions：** 查看 GitHub Actions 构建过程
4. **验证下载：** 在新环境安装测试
5. **正式发布：** 一切正常后，发布正式版本

---

## 📚 相关文档

- 详细指南：[PREBUILD_GUIDE.md](PREBUILD_GUIDE.md)
- GitHub Actions：[.github/workflows/prebuild.yml](.github/workflows/prebuild.yml)
- 预编译版 package.json：[package-prebuild.json](package-prebuild.json)

---

**需要帮助？** 查看 [PREBUILD_GUIDE.md](PREBUILD_GUIDE.md) 获取更多细节！

